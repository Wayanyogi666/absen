
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABSENSI INTERAKTIF</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
	<link rel="icon" type="image/x-icon" href="https://lh3.googleusercontent.com/d/19TNRds6ofL8omolE0436xCM_kjSw7MwN">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- SheetJS (xlsx) for Excel handling -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>


    <style>
        /* Custom styles and animations */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Softer background color */
        }

        /* Animation for page content */
        .page-content {
            animation: fadeIn 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Keyframe for nav link active animation */
        @keyframes nav-bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        /* Styling for the active navigation link */
        .nav-link.active {
            color: #2563eb; /* blue-600 */
            background-color: #eff6ff; /* blue-50 */
        }
        .nav-link.active i {
            animation: nav-bounce 0.4s ease-in-out;
        }
        
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #a8a8a8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #777; }

        /* Modal transition */
        .modal { transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        
        /* Toast Notification */
        #toast { transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out; }

        /* Enhanced button styles */
        .btn {
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .btn:active {
            transform: translateY(1px);
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        /* Input focus styles */
        input[type="text"]:focus, input[type="date"]:focus, select:focus {
            outline: none;
            border-color: #3b82f6; /* blue-500 */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
        
        /* Loading Spinner */
        #loader {
            position: fixed;
            inset: 0;
            background: #f0f4f8;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }
        .spinner {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: 8px solid #e0e0e0;
            border-top-color: #3b82f6;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased text-slate-800">

    <!-- Loader -->
    <div id="loader">
        <div class="spinner"></div>
    </div>

    <div class="flex flex-col min-h-screen">
        <!-- Main Content -->
        <main class="flex-1 p-4 md:p-8 pb-24 overflow-y-auto">
            
            <!-- Umum Page -->
            <section id="umum" class="page-content hidden">
                <h2 class="text-3xl font-bold mb-6 text-slate-700">Data Umum</h2>
                <div class="bg-white p-6 rounded-xl shadow-lg mb-6 transition-shadow duration-300 hover:shadow-2xl">
                    <form id="formPengaturan">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="namaSekolah" class="block text-slate-600 mb-2 font-medium">Nama Sekolah</label>
                                <input type="text" id="namaSekolah" class="w-full p-2 border rounded-lg bg-slate-50 transition-all duration-300">
                            </div>
                            <div>
                                <label for="namaKepsek" class="block text-slate-600 mb-2 font-medium">Nama Kepala Sekolah</label>
                                <input type="text" id="namaKepsek" class="w-full p-2 border rounded-lg bg-slate-50 transition-all duration-300">
                            </div>
                            <div>
                                <label for="nipKepsek" class="block text-slate-600 mb-2 font-medium">NIP Kepala Sekolah</label>
                                <input type="text" id="nipKepsek" class="w-full p-2 border rounded-lg bg-slate-50 transition-all duration-300">
                            </div>
                             <div>
                                <label for="namaGuru" class="block text-slate-600 mb-2 font-medium">Nama Guru</label>
                                <input type="text" id="namaGuru" class="w-full p-2 border rounded-lg bg-slate-50 transition-all duration-300">
                            </div>
                            <div>
                                <label for="nipGuru" class="block text-slate-600 mb-2 font-medium">NIP Guru</label>
                                <input type="text" id="nipGuru" class="w-full p-2 border rounded-lg bg-slate-50 transition-all duration-300">
                            </div>
                            <div>
                                <label for="kelas" class="block text-slate-600 mb-2 font-medium">Kelas</label>
                                <input type="text" id="kelas" class="w-full p-2 border rounded-lg bg-slate-50 transition-all duration-300">
                            </div>
                             <div>
                                <label for="semester" class="block text-slate-600 mb-2 font-medium">Tahun Ajaran</label>
                                <input type="text" id="semester" class="w-full p-2 border rounded-lg bg-slate-50 transition-all duration-300">
                            </div>
                             <div>
                                <label for="tempatCetak" class="block text-slate-600 mb-2 font-medium">Tempat</label>
                                <input type="text" id="tempatCetak" class="w-full p-2 border rounded-lg bg-slate-50 transition-all duration-300">
                            </div>
                        </div>
                        <div class="mt-6 text-right">
                             <button type="submit" class="btn bg-blue-600 text-white px-6 py-2 rounded-lg flex items-center ml-auto">
                                <i class="fas fa-save mr-2"></i> Simpan Data
                            </button>
                        </div>
                    </form>
                </div>

                <h2 class="text-2xl font-bold mb-4 text-slate-700">Manajemen Data</h2>
                <div class="bg-white p-6 rounded-xl shadow-lg mb-6 transition-shadow duration-300 hover:shadow-2xl">
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                         <button id="btnBackup" class="btn bg-green-600 text-white px-4 py-2 rounded-lg flex items-center justify-center">
                            <i class="fas fa-download mr-2"></i> Backup Data
                        </button>
                        <button id="btnRestore" class="btn bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center justify-center">
                            <i class="fas fa-upload mr-2"></i> Restore Data
                        </button>
                        <input type="file" id="restoreFileInput" class="hidden" accept=".json">
                        <button id="btnReset" class="btn bg-red-600 text-white px-4 py-2 rounded-lg flex items-center justify-center">
                            <i class="fas fa-sync-alt mr-2"></i> Reset Aplikasi
                        </button>
                    </div>
                </div>

                <h2 class="text-2xl font-bold mb-4 text-slate-700">Ringkasan</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-lg flex items-center space-x-4 transform hover:scale-105 transition-transform duration-300">
                        <div class="bg-blue-100 p-4 rounded-full flex items-center justify-center w-16 h-16">
                            <i class="fas fa-users text-2xl text-blue-600"></i>
                        </div>
                        <div>
                            <p class="text-slate-500">Total Siswa</p>
                            <p id="totalSiswa" class="text-2xl font-bold">0</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg flex items-center space-x-4 transform hover:scale-105 transition-transform duration-300">
                        <div class="bg-yellow-100 p-4 rounded-full flex items-center justify-center w-16 h-16">
                            <i class="fas fa-calendar-day text-2xl text-yellow-600"></i>
                        </div>
                        <div>
                            <p class="text-slate-500">Absen Hari Ini</p>
                            <p id="absenHariIni" class="text-2xl font-bold">0</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg flex items-center space-x-4 transform hover:scale-105 transition-transform duration-300">
                        <div class="bg-green-100 p-4 rounded-full flex items-center justify-center w-16 h-16">
                           <i class="fas fa-list-ol text-2xl text-green-600"></i>
                        </div>
                        <div>
                            <p class="text-slate-500">Total Absensi</p>
                            <p id="totalAbsensi" class="text-2xl font-bold">0</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Data Siswa Page -->
            <section id="data-siswa" class="page-content hidden">
                <div class="flex flex-wrap gap-2 justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-slate-700">Data Siswa</h2>
                    <div class="flex gap-2">
                        <button id="btnImporSiswa" class="btn bg-green-600 text-white px-4 py-2 rounded-lg flex items-center">
                            <i class="fas fa-file-excel mr-2"></i> Impor Siswa
                        </button>
                        <button id="btnTambahSiswa" class="btn bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center">
                            <i class="fas fa-plus mr-2"></i> Tambah Siswa
                        </button>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg transition-shadow duration-300 hover:shadow-2xl">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="border-b-2">
                                    <th class="p-4">NIS</th>
                                    <th class="p-4">Nama</th>
                                    <th class="p-4">Kelas</th>
                                    <th class="p-4 text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="tabelSiswa">
                                <!-- Data siswa akan dimuat di sini -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Absensi Page -->
            <section id="absensi" class="page-content hidden">
                <h2 class="text-3xl font-bold mb-6 text-slate-700">Input Ketidakhadiran</h2>
                <div class="bg-white p-6 rounded-xl shadow-lg transition-shadow duration-300 hover:shadow-2xl">
                    <div class="mb-4">
                        <label for="tanggalAbsen" class="block text-slate-600 mb-2 font-medium">Tanggal</label>
                        <input type="date" id="tanggalAbsen" class="w-full p-2 border rounded-lg transition-all duration-300">
                    </div>

                    <!-- Form Input Absensi -->
                    <div id="formAbsensi" class="mb-6">
                         <div class="mb-4">
                            <label for="pilihSiswa" class="block text-slate-600 mb-2 font-medium">Pilih Siswa</label>
                            <select id="pilihSiswa" class="w-full p-2 border rounded-lg bg-slate-50 transition-all duration-300"></select>
                        </div>
                        <div class="flex flex-col sm:flex-row justify-center gap-4">
                            <button data-status="Sakit" class="btn-absen btn flex-1 bg-yellow-500 text-white px-4 py-3 rounded-lg text-lg font-semibold">Sakit</button>
                            <button data-status="Izin" class="btn-absen btn flex-1 bg-blue-500 text-white px-4 py-3 rounded-lg text-lg font-semibold">Izin</button>
                            <button data-status="Alpha" class="btn-absen btn flex-1 bg-red-500 text-white px-4 py-3 rounded-lg text-lg font-semibold">Alpha</button>
                        </div>
                    </div>

                    <!-- Daftar yang tidak hadir hari ini -->
                    <div>
                        <h3 class="text-xl font-bold mb-4 text-slate-600">Siswa Tidak Hadir Hari Ini</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="border-b-2">
                                        <th class="p-4">Nama</th>
                                        <th class="p-4">Keterangan</th>
                                        <th class="p-4 text-center">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelAbsenHariIni">
                                    <!-- Data siswa tidak hadir akan dimuat di sini -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>


            <!-- Rekap Page -->
            <section id="rekap" class="page-content hidden">
                <h2 class="text-3xl font-bold mb-6 text-slate-700">Rekap Absensi</h2>
                 <div class="bg-white p-6 rounded-xl shadow-lg transition-shadow duration-300 hover:shadow-2xl">
                    <div class="flex flex-wrap gap-4 mb-4 items-end">
                        <div class="flex-1 min-w-[150px]">
                            <label for="filterBulanMulai" class="block text-slate-600 mb-2 font-medium">Dari Bulan</label>
                            <select id="filterBulanMulai" class="w-full p-2 border rounded-lg transition-all duration-300"></select>
                        </div>
                        <div class="flex-1 min-w-[150px]">
                            <label for="filterBulanSelesai" class="block text-slate-600 mb-2 font-medium">Sampai Bulan</label>
                            <select id="filterBulanSelesai" class="w-full p-2 border rounded-lg transition-all duration-300"></select>
                        </div>
                        <div class="flex-1 min-w-[150px]">
                            <label for="filterTahun" class="block text-slate-600 mb-2 font-medium">Tahun</label>
                            <select id="filterTahun" class="w-full p-2 border rounded-lg transition-all duration-300"></select>
                        </div>
                        <button id="downloadPdfBtn" class="btn bg-red-600 text-white px-4 py-2 rounded-lg flex items-center">
                            <i class="fas fa-file-pdf mr-2"></i> Download PDF
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="border-b-2">
                                    <th class="p-4">NIS</th>
                                    <th class="p-4">Nama</th>
                                    <th class="p-4 text-center">Sakit</th>
                                    <th class="p-4 text-center">Izin</th>
                                    <th class="p-4 text-center">Alpha</th>
                                </tr>
                            </thead>
                            <tbody id="tabelRekap">
                                <!-- Data rekap akan dimuat di sini -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 bg-white shadow-t-lg border-t flex justify-around z-10">
            <a href="#" class="nav-link flex-1 flex flex-col items-center justify-center p-3 text-slate-600 hover:bg-blue-50 transition-colors duration-300" data-target="umum">
                <i class="fas fa-home text-xl mb-1 transition-transform duration-300"></i>
                <span class="text-xs">Umum</span>
            </a>
            <a href="#" class="nav-link flex-1 flex flex-col items-center justify-center p-3 text-slate-600 hover:bg-blue-50 transition-colors duration-300" data-target="data-siswa">
                <i class="fas fa-users text-xl mb-1 transition-transform duration-300"></i>
                <span class="text-xs">Siswa</span>
            </a>
            <a href="#" class="nav-link flex-1 flex flex-col items-center justify-center p-3 text-slate-600 hover:bg-blue-50 transition-colors duration-300" data-target="absensi">
                <i class="fas fa-clipboard-list text-xl mb-1 transition-transform duration-300"></i>
                <span class="text-xs">Absensi</span>
            </a>
            <a href="#" class="nav-link flex-1 flex flex-col items-center justify-center p-3 text-slate-600 hover:bg-blue-50 transition-colors duration-300" data-target="rekap">
                <i class="fas fa-chart-bar text-xl mb-1 transition-transform duration-300"></i>
                <span class="text-xs">Rekap</span>
            </a>
        </nav>
    </div>

    <!-- Modal for Add/Edit Siswa -->
    <div id="siswaModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center invisible opacity-0 z-20">
        <div class="modal-content bg-white p-8 rounded-xl shadow-2xl w-full max-w-md transform scale-95">
            <div class="flex justify-between items-center mb-6">
                <h3 id="modalTitle" class="text-2xl font-bold">Tambah Siswa</h3>
                <button id="closeModal" class="text-slate-500 hover:text-slate-800 transition-transform duration-200 hover:scale-125">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <form id="siswaForm">
                <input type="hidden" id="siswaId">
                <div class="mb-4">
                    <label for="nis" class="block text-slate-600 mb-2">NIS</label>
                    <input type="text" id="nis" class="w-full p-2 border rounded-lg transition-all duration-300" required>
                </div>
                <div class="mb-4">
                    <label for="nama" class="block text-slate-600 mb-2">Nama</label>
                    <input type="text" id="nama" class="w-full p-2 border rounded-lg transition-all duration-300" required>
                </div>
                <div class="mb-6">
                    <label for="kelasSiswa" class="block text-slate-600 mb-2">Kelas</label>
                    <input type="text" id="kelasSiswa" class="w-full p-2 border rounded-lg transition-all duration-300" required>
                </div>
                <div class="flex justify-end">
                    <button type="submit" class="btn bg-blue-600 text-white px-6 py-2 rounded-lg">Simpan</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal for Import Siswa -->
    <div id="importModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center invisible opacity-0 z-20">
        <div class="modal-content bg-white p-8 rounded-xl shadow-2xl w-full max-w-md transform scale-95">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold">Impor Data Siswa</h3>
                <button id="closeImportModal" class="text-slate-500 hover:text-slate-800 transition-transform duration-200 hover:scale-125">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <div>
                <p class="text-slate-600 mb-4">Unggah file Excel (.xlsx) untuk mengimpor data siswa. Pastikan format file sesuai dengan contoh.</p>
                <button id="downloadFormatBtn" class="btn w-full mb-4 bg-green-600 text-white px-4 py-2 rounded-lg flex items-center justify-center">
                    <i class="fas fa-download mr-2"></i> Download Format
                </button>
                <div class="border-2 border-dashed border-slate-300 rounded-lg p-6 text-center">
                    <label for="fileInput" class="cursor-pointer">
                        <i class="fas fa-cloud-upload-alt text-4xl text-slate-400 mb-2"></i>
                        <p class="text-slate-500">Pilih file atau seret ke sini</p>
                    </label>
                    <input type="file" id="fileInput" class="hidden" accept=".xlsx, .xls">
                    <p id="fileName" class="text-sm text-slate-600 mt-2"></p>
                </div>
                <div class="flex justify-end mt-6">
                    <button id="importBtn" class="btn bg-blue-600 text-white px-6 py-2 rounded-lg disabled:bg-slate-400 disabled:cursor-not-allowed disabled:transform-none disabled:shadow-none" disabled>Impor</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="confirmModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center invisible opacity-0 z-30">
        <div class="modal-content bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm text-center transform scale-95">
            <h3 id="confirmTitle" class="text-xl font-bold mb-4">Apakah Anda yakin?</h3>
            <p id="confirmMessage" class="text-slate-600 mb-6">Data yang dihapus tidak dapat dikembalikan.</p>
            <div class="flex justify-center gap-4">
                <button id="confirmCancel" class="btn bg-slate-200 text-slate-800 px-6 py-2 rounded-lg">Batal</button>
                <button id="confirmOk" class="btn bg-red-600 text-white px-6 py-2 rounded-lg">Hapus</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-24 md:bottom-5 right-5 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 z-40">
        <i class="fas fa-check-circle mr-2"></i>
        <span id="toastMessage"></span>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DEFAULT DATA ---
            const defaultPengaturan = {
                namaSekolah: 'SDN 7 Pedungan',
                namaKepsek: 'XXXXX',
                nipKepsek: '12345',
                namaGuru: 'I Wayan Yogi',
                nipGuru: '0817567146',
                kelas: '6',
                semester: '2025/2026', // UPDATED
                tempatCetak: 'Denpasar' // UPDATED
            };

            const defaultSiswa = [
                { id: 1668150000001, nis: '1000', nama: 'I Wayan', kelas: '6' },
                { id: 1668150000002, nis: '1001', nama: 'Sri Mulyono', kelas: '6' },
                { id: 1668150000003, nis: '1002', nama: 'Si Beban Negara', kelas: '6' },
                
            ];

            // --- STATE MANAGEMENT ---
            let state = {
                pengaturan: JSON.parse(localStorage.getItem('pengaturan')) || defaultPengaturan,
                siswa: JSON.parse(localStorage.getItem('siswa')) || defaultSiswa,
                absensi: JSON.parse(localStorage.getItem('absensi')) || [],
            };
            let importedFile = null;

            // --- UTILITY FUNCTIONS ---
            const saveState = () => {
                localStorage.setItem('pengaturan', JSON.stringify(state.pengaturan));
                localStorage.setItem('siswa', JSON.stringify(state.siswa));
                localStorage.setItem('absensi', JSON.stringify(state.absensi));
            };
            
            const getTodayDate = () => {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            
            const showToast = (message, isError = false) => {
                const toast = document.getElementById('toast');
                document.getElementById('toastMessage').textContent = message;
                toast.classList.toggle('bg-red-500', isError);
                toast.classList.toggle('bg-green-500', !isError);
                toast.classList.remove('translate-y-20', 'opacity-0');
                setTimeout(() => {
                    toast.classList.add('translate-y-20', 'opacity-0');
                }, 3000);
            };

            // --- MODAL HANDLING ---
            const siswaModal = document.getElementById('siswaModal');
            const importModal = document.getElementById('importModal');
            const confirmModal = document.getElementById('confirmModal');
            
            const openModal = (modal) => {
                modal.classList.remove('invisible', 'opacity-0');
                modal.querySelector('.modal-content').classList.remove('scale-95');
            };

            const closeModal = (modal) => {
                modal.classList.add('invisible', 'opacity-0');
                modal.querySelector('.modal-content').classList.add('scale-95');
            };

            const showConfirmation = (title, message) => {
                return new Promise((resolve) => {
                    document.getElementById('confirmTitle').textContent = title;
                    document.getElementById('confirmMessage').textContent = message;
                    openModal(confirmModal);

                    document.getElementById('confirmOk').onclick = () => {
                        closeModal(confirmModal);
                        resolve(true);
                    };
                    document.getElementById('confirmCancel').onclick = () => {
                        closeModal(confirmModal);
                        resolve(false);
                    };
                });
            };

            // --- RENDER FUNCTIONS ---
            const renderPengaturan = () => {
                document.getElementById('namaSekolah').value = state.pengaturan.namaSekolah;
                document.getElementById('namaKepsek').value = state.pengaturan.namaKepsek;
                document.getElementById('nipKepsek').value = state.pengaturan.nipKepsek;
                document.getElementById('namaGuru').value = state.pengaturan.namaGuru;
                document.getElementById('nipGuru').value = state.pengaturan.nipGuru;
                document.getElementById('kelas').value = state.pengaturan.kelas;
                document.getElementById('semester').value = state.pengaturan.semester;
                document.getElementById('tempatCetak').value = state.pengaturan.tempatCetak;
            };

            const renderTabelSiswa = () => {
                const tabelSiswa = document.getElementById('tabelSiswa');
                tabelSiswa.innerHTML = '';
                if (state.siswa.length === 0) {
                    tabelSiswa.innerHTML = `<tr><td colspan="4" class="text-center p-4 text-slate-500">Belum ada data siswa.</td></tr>`;
                    return;
                }
                state.siswa.forEach(s => {
                    const tr = document.createElement('tr');
                    tr.className = 'border-b hover:bg-slate-50';
                    tr.innerHTML = `
                        <td class="p-4">${s.nis}</td>
                        <td class="p-4">${s.nama}</td>
                        <td class="p-4">${s.kelas}</td>
                        <td class="p-4 text-center">
                            <button class="text-blue-500 hover:text-blue-700 p-2 transition-transform duration-200 hover:scale-125 edit-btn" data-id="${s.id}">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                            <button class="text-red-500 hover:text-red-700 p-2 transition-transform duration-200 hover:scale-125 hapus-btn" data-id="${s.id}">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    `;
                    tabelSiswa.appendChild(tr);
                });
            };

            const renderAbsensiPage = () => {
                const tanggal = document.getElementById('tanggalAbsen').value;
                const pilihSiswaSelect = document.getElementById('pilihSiswa');
                const tabelAbsenHariIni = document.getElementById('tabelAbsenHariIni');
                const formAbsensi = document.getElementById('formAbsensi');

                const absentSiswaIds = state.absensi
                    .filter(a => a.tanggal === tanggal)
                    .map(a => a.siswaId);

                const availableSiswa = state.siswa.filter(s => !absentSiswaIds.includes(s.id));
                pilihSiswaSelect.innerHTML = '';
                
                if (availableSiswa.length > 0) {
                    formAbsensi.style.display = 'block';
                    availableSiswa.forEach(s => {
                        const option = document.createElement('option');
                        option.value = s.id;
                        option.textContent = `${s.nis} - ${s.nama}`;
                        pilihSiswaSelect.appendChild(option);
                    });
                } else {
                    formAbsensi.style.display = 'none';
                }

                const absentSiswa = state.absensi.filter(a => a.tanggal === tanggal);
                tabelAbsenHariIni.innerHTML = '';
                if (absentSiswa.length > 0) {
                    absentSiswa.forEach(absen => {
                        const siswa = state.siswa.find(s => s.id === absen.siswaId);
                        if (siswa) {
                            const tr = document.createElement('tr');
                            tr.className = 'border-b hover:bg-slate-50';
                            tr.innerHTML = `
                                <td class="p-4">${siswa.nama}</td>
                                <td class="p-4">${absen.keterangan}</td>
                                <td class="p-4 text-center">
                                    <button class="text-red-500 hover:text-red-700 p-2 transition-transform duration-200 hover:scale-125 hapus-absen-btn" data-id="${absen.id}">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </td>
                            `;
                            tabelAbsenHariIni.appendChild(tr);
                        }
                    });
                } else {
                    tabelAbsenHariIni.innerHTML = `<tr><td colspan="3" class="text-center p-4 text-slate-500">Semua siswa hadir hari ini.</td></tr>`;
                }
            };
            
            const renderRekap = () => {
                const tabelRekap = document.getElementById('tabelRekap');
                const bulanMulai = parseInt(document.getElementById('filterBulanMulai').value);
                const bulanSelesai = parseInt(document.getElementById('filterBulanSelesai').value);
                const tahun = parseInt(document.getElementById('filterTahun').value);
                tabelRekap.innerHTML = '';
                
                state.siswa.forEach(s => {
                    const rekap = { Sakit: 0, Izin: 0, Alpha: 0 };
                    state.absensi.forEach(a => {
                        const absenDate = new Date(a.tanggal);
                        const absenMonth = absenDate.getMonth() + 1;
                        const absenYear = absenDate.getFullYear();

                        if (a.siswaId === s.id && absenYear === tahun && absenMonth >= bulanMulai && absenMonth <= bulanSelesai) {
                            if (rekap[a.keterangan] !== undefined) {
                                rekap[a.keterangan]++;
                            }
                        }
                    });

                    const tr = document.createElement('tr');
                    tr.className = 'border-b hover:bg-slate-50';
                    tr.innerHTML = `
                        <td class="p-4">${s.nis}</td>
                        <td class="p-4">${s.nama}</td>
                        <td class="p-4 text-center">${rekap.Sakit}</td>
                        <td class="p-4 text-center">${rekap.Izin}</td>
                        <td class="p-4 text-center">${rekap.Alpha}</td>
                    `;
                    tabelRekap.appendChild(tr);
                });
                 if (state.siswa.length === 0) {
                    tabelRekap.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-slate-500">Belum ada data siswa.</td></tr>`;
                }
            };

            const updateDashboard = () => {
                const today = getTodayDate();
                document.getElementById('totalSiswa').textContent = state.siswa.length;
                const absenHariIni = state.absensi.filter(a => a.tanggal === today && a.keterangan !== 'Hadir').length;
                document.getElementById('absenHariIni').textContent = absenHariIni;
                const totalAbsensi = state.absensi.filter(a => a.keterangan !== 'Hadir').length;
                document.getElementById('totalAbsensi').textContent = totalAbsensi;
            };
            
            const populateFilterOptions = () => {
                const bulanMulaiSelect = document.getElementById('filterBulanMulai');
                const bulanSelesaiSelect = document.getElementById('filterBulanSelesai');
                const tahunSelect = document.getElementById('filterTahun');
                const bulanIni = new Date().getMonth() + 1;
                const tahunIni = new Date().getFullYear();

                const namaBulan = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
                bulanMulaiSelect.innerHTML = '';
                bulanSelesaiSelect.innerHTML = '';
                namaBulan.forEach((bulan, index) => {
                    const option1 = document.createElement('option');
                    option1.value = index + 1;
                    option1.textContent = bulan;
                    bulanMulaiSelect.appendChild(option1);
                    
                    const option2 = document.createElement('option');
                    option2.value = index + 1;
                    option2.textContent = bulan;
                    bulanSelesaiSelect.appendChild(option2);
                });
                bulanMulaiSelect.value = bulanIni;
                bulanSelesaiSelect.value = bulanIni;


                const years = [...new Set(state.absensi.map(a => new Date(a.tanggal).getFullYear()))];
                if (!years.includes(tahunIni)) years.push(tahunIni);
                if (years.length === 0) years.push(tahunIni);
                tahunSelect.innerHTML = '';
                years.sort().reverse().forEach(tahun => {
                    const option = document.createElement('option');
                    option.value = tahun;
                    option.textContent = tahun;
                    if (tahun === tahunIni) option.selected = true;
                    tahunSelect.appendChild(option);
                });
            };

            // --- EVENT HANDLERS ---
            const handlePengaturanFormSubmit = (e) => {
                e.preventDefault();
                state.pengaturan.namaSekolah = document.getElementById('namaSekolah').value;
                state.pengaturan.namaKepsek = document.getElementById('namaKepsek').value;
                state.pengaturan.nipKepsek = document.getElementById('nipKepsek').value;
                state.pengaturan.namaGuru = document.getElementById('namaGuru').value;
                state.pengaturan.nipGuru = document.getElementById('nipGuru').value;
                state.pengaturan.kelas = document.getElementById('kelas').value;
                state.pengaturan.semester = document.getElementById('semester').value;
                state.pengaturan.tempatCetak = document.getElementById('tempatCetak').value;
                saveState();
                showToast('Data umum berhasil disimpan!');
            };

            const handleSiswaFormSubmit = (e) => {
                e.preventDefault();
                const id = document.getElementById('siswaId').value;
                const nis = document.getElementById('nis').value;
                const nama = document.getElementById('nama').value;
                const kelas = document.getElementById('kelasSiswa').value;

                if (id) { // Edit
                    const index = state.siswa.findIndex(s => s.id == id);
                    state.siswa[index] = { ...state.siswa[index], nis, nama, kelas };
                } else { // Add
                    const newSiswa = { id: Date.now(), nis, nama, kelas };
                    state.siswa.push(newSiswa);
                }
                saveState();
                renderTabelSiswa();
                updateDashboard();
                closeModal(siswaModal);
            };

            const handleEditSiswa = (id) => {
                const siswa = state.siswa.find(s => s.id == id);
                document.getElementById('modalTitle').textContent = 'Edit Siswa';
                document.getElementById('siswaId').value = siswa.id;
                document.getElementById('nis').value = siswa.nis;
                document.getElementById('nama').value = siswa.nama;
                document.getElementById('kelasSiswa').value = siswa.kelas;
                openModal(siswaModal);
            };

            const handleHapusSiswa = async (id) => {
                const confirmed = await showConfirmation('Hapus Siswa?', 'Tindakan ini juga akan menghapus semua data absensi siswa terkait.');
                if (confirmed) {
                    state.siswa = state.siswa.filter(s => s.id != id);
                    state.absensi = state.absensi.filter(a => a.siswaId != id);
                    saveState();
                    renderTabelSiswa();
                    updateDashboard();
                }
            };
            
            const handleAbsenButtonClick = (e) => {
                if (e.target.classList.contains('btn-absen')) {
                    const siswaId = document.getElementById('pilihSiswa').value;
                    const tanggal = document.getElementById('tanggalAbsen').value;
                    const keterangan = e.target.dataset.status;

                    if (!siswaId) {
                        showToast('Tidak ada siswa yang dipilih.', true);
                        return;
                    }

                    state.absensi.push({
                        id: Date.now(),
                        siswaId: Number(siswaId),
                        tanggal: tanggal,
                        keterangan: keterangan
                    });

                    saveState();
                    updateDashboard();
                    renderAbsensiPage();
                }
            };

            const handleHapusAbsen = (absenId) => {
                state.absensi = state.absensi.filter(a => a.id != absenId);
                saveState();
                updateDashboard();
                renderAbsensiPage();
            };
            
            const handleDownloadFormat = () => {
                const dataToExport = state.siswa.length > 0 
                    ? state.siswa.map(({ nis, nama, kelas }) => ({ NIS: nis, Nama: nama, Kelas: kelas }))
                    : [{ NIS: '1001', Nama: 'Contoh Nama Siswa', Kelas: '5' }];

                const ws = XLSX.utils.json_to_sheet(dataToExport);
                ws['!cols'] = [{ wch: 15 }, { wch: 40 }, { wch: 15 }]; // Set column widths
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "BangbinSiswa");
                XLSX.writeFile(wb, "Bangbin_Absen_siswa.xlsx");
            };
            
            const handleFileImport = async () => {
                if (!importedFile) {
                    showToast('Silakan pilih file terlebih dahulu.', true);
                    return;
                }

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);

                        if (jsonData.length === 0) {
                            showToast('File Excel kosong atau format tidak sesuai.', true);
                            return;
                        }
                        
                        const confirmed = await showConfirmation('Konfirmasi Impor', `Anda akan mengimpor ${jsonData.length} data siswa. Data dengan NIS yang sama akan diperbarui. Lanjutkan?`);

                        if (confirmed) {
                            let importedCount = 0;
                            let updatedCount = 0;
                            jsonData.forEach(row => {
                                const nis = String(row.NIS || '').trim();
                                const nama = String(row.Nama || '').trim();
                                const kelas = String(row.Kelas || '').trim();

                                if (nis && nama && kelas) {
                                    const existingSiswaIndex = state.siswa.findIndex(s => s.nis === nis);
                                    if (existingSiswaIndex > -1) {
                                        // Update existing
                                        state.siswa[existingSiswaIndex] = { ...state.siswa[existingSiswaIndex], nama, kelas };
                                        updatedCount++;
                                    } else {
                                        // Add new
                                        state.siswa.push({ id: Date.now() + importedCount, nis, nama, kelas });
                                        importedCount++;
                                    }
                                }
                            });
                            saveState();
                            renderTabelSiswa();
                            updateDashboard();
                            showToast(`${importedCount} siswa baru diimpor, ${updatedCount} siswa diperbarui.`);
                            closeModal(importModal);
                        }
                    } catch (error) {
                        console.error("Error reading file:", error);
                        showToast('Gagal memproses file. Pastikan format benar.', true);
                    }
                };
                reader.readAsArrayBuffer(importedFile);
            };
            
            const handleDownloadPdf = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                const bulanMulaiSelect = document.getElementById('filterBulanMulai');
                const bulanSelesaiSelect = document.getElementById('filterBulanSelesai');
                const tahun = document.getElementById('filterTahun').value;
                const bulanMulaiNama = bulanMulaiSelect.options[bulanMulaiSelect.selectedIndex].text;
                const bulanSelesaiNama = bulanSelesaiSelect.options[bulanSelesaiSelect.selectedIndex].text;
                const periodeBulan = bulanMulaiSelect.value === bulanSelesaiSelect.value ? bulanMulaiNama : `${bulanMulaiNama} - ${bulanSelesaiNama}`;

                // Header
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('REKAPITULASI ABSENSI SISWA', doc.internal.pageSize.getWidth() / 2, 15, { align: 'center' });
                doc.setFontSize(12);
                doc.text(state.pengaturan.namaSekolah.toUpperCase(), doc.internal.pageSize.getWidth() / 2, 22, { align: 'center' });
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text(`Kelas: ${state.pengaturan.kelas}`, 14, 35);
                doc.text(`Tahun Ajaran: ${state.pengaturan.semester}`, 14, 40);
                doc.text(`Bulan: ${periodeBulan} ${tahun}`, doc.internal.pageSize.getWidth() - 14, 35, { align: 'right' });


                // Table
                const tableHead = [['NIS', 'Nama Siswa', 'Sakit', 'Izin', 'Alpha']];
                const tableBody = [];
                const tableRows = document.querySelectorAll('#tabelRekap tr');
                tableRows.forEach(row => {
                    const rowData = [];
                    row.querySelectorAll('td').forEach(cell => {
                        rowData.push(cell.textContent);
                    });
                    tableBody.push(rowData);
                });

                if (tableBody.length === 0) {
                    showToast('Tidak ada data rekap untuk diunduh.', true);
                    return;
                }

                doc.autoTable({
                    head: tableHead,
                    body: tableBody,
                    startY: 45,
                    theme: 'grid',
                    headStyles: { fillColor: [41, 128, 185], textColor: 255, fontStyle: 'bold' },
                    styles: { cellPadding: 2, fontSize: 9 },
                });

                // Signature
                const finalY = doc.autoTable.previous.finalY;
                const today = new Date();
                const namaBulan = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
                const tanggalCetak = `${state.pengaturan.tempatCetak}, ${today.getDate()} ${namaBulan[today.getMonth()]} ${today.getFullYear()}`;

                doc.setFontSize(10);
                doc.text(tanggalCetak, doc.internal.pageSize.getWidth() - 14, finalY + 15, { align: 'right' });
                
                doc.text('Mengetahui,', 14, finalY + 25);
                doc.text('Kepala Sekolah', 14, finalY + 30);
                doc.text(state.pengaturan.namaKepsek, 14, finalY + 50);
                doc.setFont('helvetica', 'bold');
                doc.text(`NIP. ${state.pengaturan.nipKepsek}`, 14, finalY + 55);

                doc.setFont('helvetica', 'normal');
                doc.text('Guru Kelas', doc.internal.pageSize.getWidth() - 14, finalY + 30, { align: 'right' });
                doc.text(state.pengaturan.namaGuru, doc.internal.pageSize.getWidth() - 14, finalY + 50, { align: 'right' });
                doc.setFont('helvetica', 'bold');
                doc.text(`NIP. ${state.pengaturan.nipGuru}`, doc.internal.pageSize.getWidth() - 14, finalY + 55, { align: 'right' });

                // Save
                doc.save(`Rekap Absensi Kelas ${state.pengaturan.kelas} - ${periodeBulan} ${tahun}.pdf`);
            };
            
            const handleBackup = () => {
                const dataStr = JSON.stringify(state);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                const today = getTodayDate();
                link.download = `absensi_backup_${today}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                showToast('Backup data berhasil diunduh.');
            };

            const handleRestore = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const restoredState = JSON.parse(event.target.result);
                        if (restoredState.pengaturan && restoredState.siswa && restoredState.absensi) {
                            const confirmed = await showConfirmation('Konfirmasi Restore', 'Anda yakin ingin menimpa semua data saat ini dengan data dari file backup?');
                            if (confirmed) {
                                state = restoredState;
                                saveState();
                                showToast('Data berhasil dipulihkan. Aplikasi akan dimuat ulang.');
                                setTimeout(() => location.reload(), 1500);
                            }
                        } else {
                            showToast('File backup tidak valid.', true);
                        }
                    } catch (err) {
                        showToast('Gagal membaca file backup.', true);
                    }
                };
                reader.readAsText(file);
                e.target.value = ''; // Reset file input
            };

            const handleReset = async () => {
                const confirmed = await showConfirmation('Reset Aplikasi', 'Semua data (pengaturan, siswa, absensi) akan dihapus permanen dan aplikasi akan kembali ke pengaturan awal. Anda yakin?');
                if (confirmed) {
                    localStorage.clear();
                    showToast('Aplikasi berhasil di-reset. Aplikasi akan dimuat ulang.');
                    setTimeout(() => location.reload(), 1500);
                }
            };


            // --- NAVIGATION ---
            const navLinks = document.querySelectorAll('.nav-link');
            const pages = document.querySelectorAll('.page-content');

            const switchPage = (targetId) => {
                pages.forEach(page => {
                    page.classList.toggle('hidden', page.id !== targetId);
                });
                navLinks.forEach(link => {
                    link.classList.toggle('active', link.dataset.target === targetId);
                });

                if (targetId === 'data-siswa') renderTabelSiswa();
                if (targetId === 'absensi') renderAbsensiPage();
                if (targetId === 'rekap') {
                    populateFilterOptions();
                    renderRekap();
                }
                if (targetId === 'umum') {
                    renderPengaturan();
                    updateDashboard();
                }
            };

            // --- INITIALIZATION & EVENT LISTENERS ---
            window.addEventListener('load', () => {
                const loader = document.getElementById('loader');
                loader.style.opacity = '0';
                setTimeout(() => {
                    loader.style.display = 'none';
                    saveState(); // Save initial default state if local storage is empty
                    switchPage('absensi'); // UPDATED: Start on absensi page
                }, 500); // Match CSS transition duration
            });

            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    switchPage(link.dataset.target);
                });
            });
            
            document.getElementById('formPengaturan').addEventListener('submit', handlePengaturanFormSubmit);

            document.getElementById('btnTambahSiswa').addEventListener('click', () => {
                document.getElementById('modalTitle').textContent = 'Tambah Siswa';
                document.getElementById('siswaForm').reset();
                document.getElementById('siswaId').value = '';
                document.getElementById('kelasSiswa').value = state.pengaturan.kelas; // Auto-fill kelas
                openModal(siswaModal);
            });

            document.getElementById('closeModal').addEventListener('click', () => closeModal(siswaModal));
            document.getElementById('siswaForm').addEventListener('submit', handleSiswaFormSubmit);

            document.getElementById('tabelSiswa').addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-btn');
                const hapusBtn = e.target.closest('.hapus-btn');
                if (editBtn) {
                    handleEditSiswa(editBtn.dataset.id);
                }
                if (hapusBtn) {
                    handleHapusSiswa(hapusBtn.dataset.id);
                }
            });
            
            const tanggalAbsenInput = document.getElementById('tanggalAbsen');
            tanggalAbsenInput.value = getTodayDate();
            tanggalAbsenInput.addEventListener('change', renderAbsensiPage);
            
            document.getElementById('formAbsensi').addEventListener('click', handleAbsenButtonClick);
            
            document.getElementById('tabelAbsenHariIni').addEventListener('click', (e) => {
                const hapusBtn = e.target.closest('.hapus-absen-btn');
                if (hapusBtn) {
                    handleHapusAbsen(hapusBtn.dataset.id);
                }
            });
            
            document.getElementById('filterBulanMulai').addEventListener('change', renderRekap);
            document.getElementById('filterBulanSelesai').addEventListener('change', renderRekap);
            document.getElementById('filterTahun').addEventListener('change', renderRekap);
            document.getElementById('downloadPdfBtn').addEventListener('click', handleDownloadPdf);
            
            // --- Import Modal Listeners ---
            const importBtn = document.getElementById('importBtn');
            const fileInput = document.getElementById('fileInput');
            
            document.getElementById('btnImporSiswa').addEventListener('click', () => {
                // Reset import modal state
                importedFile = null;
                fileInput.value = '';
                document.getElementById('fileName').textContent = '';
                importBtn.disabled = true;
                openModal(importModal);
            });
            document.getElementById('closeImportModal').addEventListener('click', () => closeModal(importModal));
            document.getElementById('downloadFormatBtn').addEventListener('click', handleDownloadFormat);
            importBtn.addEventListener('click', handleFileImport);
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    importedFile = e.target.files[0];
                    document.getElementById('fileName').textContent = importedFile.name;
                    importBtn.disabled = false;
                } else {
                    importedFile = null;
                    document.getElementById('fileName').textContent = '';
                    importBtn.disabled = true;
                }
            });

            // --- Data Management Listeners ---
            document.getElementById('btnBackup').addEventListener('click', handleBackup);
            document.getElementById('btnRestore').addEventListener('click', () => document.getElementById('restoreFileInput').click());
            document.getElementById('restoreFileInput').addEventListener('change', handleRestore);
            document.getElementById('btnReset').addEventListener('click', handleReset);
        });
    </script>
</body>
</html>
